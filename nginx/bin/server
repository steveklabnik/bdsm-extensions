#!/usr/bin/env bash

project="${extension_args[0]:-$1}"

if variable_is_nonempty project
then
  if template_exists "server.conf"
  then
    ensure_paths_exist "$nginx_servers_path"

    chmod_paths --recursive 'g+rx' "/home/${project}"

    if (( force_flag == 1 ))
    then
      if file_exists "${nginx_servers_path}/${project}.conf"
      then
        remove_file "${nginx_servers_path}/${project}.conf"
      fi
    fi

    if file_is_missing "${nginx_servers_path}/${project}.conf"
    then
      install_template "server.conf" to "${nginx_servers_path}/${project}.conf"

      seed_template "${nginx_servers_path}/${project}.conf" \
        project "${project}"
    else
      warn "Not installing template ${nginx_servers_path}/${project}.conf"\
        "as the file already exists"
    fi
  else
    fail "ERROR: $extension_templates_path/server.conf template is missing."
  fi
else
  fail "project must be specified for 'nginx server'"
fi

